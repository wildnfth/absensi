<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Absensi</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;1,400&family=Plus+Jakarta+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --pink:    #e8a0bf;
  --pink-d:  #d4789f;
  --purple:  #c4a8e0;
  --purple-d:#a87fc8;
  --bg:      #fefcff;
  --surface: #ffffff;
  --border:  #f0e6f6;
  --text:    #3a2a4a;
  --muted:   #b89ccc;
  --hadir:   #a8d4b8;
  --lembur:  #e8a0bf;
  --libur:   #a8c4e8;
  --cuti:    #c4a8e0;
  --red:     #e06080;
}

body {
  font-family: 'Plus Jakarta Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  background-image:
    radial-gradient(ellipse at 0% 0%, rgba(232,160,191,0.15) 0%, transparent 60%),
    radial-gradient(ellipse at 100% 100%, rgba(196,168,224,0.15) 0%, transparent 60%);
}

/* AUTH */
#auth-screen {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2rem;
}

.auth-wrap { width: 100%; max-width: 400px; }

.auth-logo { text-align: center; margin-bottom: 2.5rem; }

.auth-logo h1 {
  font-family: 'Playfair Display', serif;
  font-size: 2.8rem;
  font-weight: 400;
  background: linear-gradient(135deg, var(--pink-d), var(--purple-d));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.auth-logo p {
  font-size: 0.75rem;
  color: var(--muted);
  letter-spacing: 0.12em;
  text-transform: uppercase;
  margin-top: 0.4rem;
}

.auth-card {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 24px;
  padding: 2.5rem;
  box-shadow: 0 8px 40px rgba(196,168,224,0.12);
}

.form-group { margin-bottom: 1.1rem; }

.form-group label {
  display: block;
  font-size: 0.7rem;
  font-weight: 600;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 0.45rem;
}

.form-group input {
  width: 100%;
  padding: 0.75rem 1rem;
  background: var(--bg);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 0.9rem;
  color: var(--text);
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.form-group input:focus {
  border-color: var(--pink);
  box-shadow: 0 0 0 4px rgba(232,160,191,0.1);
}

.btn-primary {
  width: 100%;
  padding: 0.85rem;
  background: linear-gradient(135deg, var(--pink-d), var(--purple-d));
  color: white;
  border: none;
  border-radius: 12px;
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 0.88rem;
  font-weight: 600;
  cursor: pointer;
  margin-top: 0.5rem;
  box-shadow: 0 4px 16px rgba(212,120,159,0.3);
  transition: opacity 0.2s, transform 0.1s;
}

.btn-primary:hover { opacity: 0.88; }
.btn-primary:active { transform: scale(0.99); }

.btn-ghost {
  width: 100%;
  padding: 0.75rem;
  background: transparent;
  border: 1.5px solid var(--border);
  border-radius: 12px;
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 0.83rem;
  color: var(--muted);
  cursor: pointer;
  margin-top: 0.6rem;
  transition: border-color 0.2s, color 0.2s;
}

.btn-ghost:hover { border-color: var(--pink); color: var(--pink-d); }

.auth-msg {
  font-size: 0.78rem;
  margin-top: 0.9rem;
  display: none;
  text-align: center;
}

/* APP */
#app { display: none; }

header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 2rem;
  background: rgba(254,252,255,0.9);
  backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
}

.logo {
  font-family: 'Playfair Display', serif;
  font-size: 1.5rem;
  font-weight: 400;
  background: linear-gradient(135deg, var(--pink-d), var(--purple-d));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.header-right { display: flex; align-items: center; gap: 1rem; }

.user-chip {
  font-size: 0.7rem;
  color: var(--muted);
  padding: 0.3rem 0.8rem;
  background: var(--border);
  border-radius: 20px;
}

.btn-out {
  font-size: 0.75rem;
  font-family: 'Plus Jakarta Sans', sans-serif;
  color: var(--muted);
  background: transparent;
  border: 1.5px solid var(--border);
  border-radius: 20px;
  padding: 0.3rem 0.9rem;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-out:hover { border-color: var(--red); color: var(--red); }

/* LAYOUT */
.layout {
  max-width: 1100px;
  margin: 0 auto;
  padding: 2rem 1.5rem;
  display: grid;
  grid-template-columns: 1fr 270px;
  gap: 2rem;
  align-items: start;
}

/* CALENDAR */
.cal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1.2rem;
}

.period-label {
  font-family: 'Playfair Display', serif;
  font-size: 1.25rem;
  font-weight: 400;
  color: var(--text);
}

.nav-btn {
  width: 36px; height: 36px;
  border-radius: 50%;
  border: 1.5px solid var(--border);
  background: var(--surface);
  color: var(--muted);
  cursor: pointer;
  font-size: 0.9rem;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
  box-shadow: 0 2px 8px rgba(196,168,224,0.1);
}

.nav-btn:hover { border-color: var(--pink); color: var(--pink-d); }

.cal-box {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 24px;
  padding: 1.5rem;
  box-shadow: 0 4px 24px rgba(196,168,224,0.08);
}

.day-names {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  margin-bottom: 0.5rem;
}

.day-name {
  text-align: center;
  font-size: 0.6rem;
  font-weight: 600;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--muted);
  padding: 0.4rem 0;
}

.day-name.we { color: var(--pink-d); }

.cal-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 3px;
}

.cal-cell {
  aspect-ratio: 1;
  border-radius: 50%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  border: 1.5px solid transparent;
  transition: all 0.15s;
  user-select: none;
  position: relative;
}

.cal-cell:hover:not(.empty) { background: var(--border); border-color: var(--pink); }
.cal-cell.empty { cursor: default; opacity: 0; pointer-events: none; }
.cal-cell.today { border-color: var(--pink-d) !important; background: rgba(232,160,191,0.08); }
.cal-cell.weekend .cal-date { color: var(--pink); }

.cal-date { font-size: 0.8rem; font-weight: 400; line-height: 1; text-align: center; }

.month-tag {
  font-size: 0.46rem;
  font-weight: 600;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  color: var(--pink-d);
  line-height: 1;
  margin-bottom: 1px;
}

.cal-dot { width: 4px; height: 4px; border-radius: 50%; margin-top: 2px; }

.cal-cell.hadir  { background: rgba(168,212,184,0.25); border-color: rgba(168,212,184,0.6); }
.cal-cell.lembur { background: rgba(232,160,191,0.22); border-color: rgba(232,160,191,0.6); }
.cal-cell.libur  { background: rgba(168,196,232,0.22); border-color: rgba(168,196,232,0.6); }
.cal-cell.cuti   { background: rgba(196,168,224,0.22); border-color: rgba(196,168,224,0.6); }

.cal-cell.hadir  .cal-date { color: #5a9e78; }
.cal-cell.lembur .cal-date { color: var(--pink-d); }
.cal-cell.libur  .cal-date { color: #5a82b4; }
.cal-cell.cuti   .cal-date { color: var(--purple-d); }

.cal-cell.hadir  .cal-dot { background: #5a9e78; }
.cal-cell.lembur .cal-dot { background: var(--pink-d); }
.cal-cell.libur  .cal-dot { background: #5a82b4; }
.cal-cell.cuti   .cal-dot { background: var(--purple-d); }

/* SIDEBAR */
.sidebar { display: flex; flex-direction: column; gap: 1rem; }

.period-chip {
  background: linear-gradient(135deg, rgba(232,160,191,0.1), rgba(196,168,224,0.1));
  border: 1.5px solid var(--border);
  border-radius: 16px;
  padding: 1rem 1.25rem;
}

.chip-label {
  font-size: 0.6rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--muted);
  margin-bottom: 0.3rem;
}

.chip-val {
  font-family: 'Playfair Display', serif;
  font-size: 1rem;
  color: var(--pink-d);
}

.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.7rem; }

.stat-card {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 16px;
  padding: 1rem 1rem 0.85rem;
  box-shadow: 0 2px 12px rgba(196,168,224,0.07);
  transition: transform 0.2s;
}

.stat-card:hover { transform: translateY(-2px); }
.stat-lbl { font-size: 0.58rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 0.3rem; }
.stat-val { font-family: 'Playfair Display', serif; font-size: 2.4rem; font-weight: 400; line-height: 1; }
.stat-unit { font-size: 0.6rem; color: var(--muted); margin-top: 0.15rem; }

.c-hadir  .stat-val { color: #5a9e78; }
.c-lembur .stat-val { color: var(--pink-d); }
.c-libur  .stat-val { color: #5a82b4; }
.c-cuti   .stat-val { color: var(--purple-d); }

.legend-box {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 16px;
  padding: 1rem 1.25rem;
}

.legend-box .leg-title { font-size: 0.6rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.12em; color: var(--muted); margin-bottom: 0.75rem; }

.leg-item { display: flex; align-items: center; gap: 0.6rem; font-size: 0.78rem; color: var(--text); margin-bottom: 0.45rem; }
.leg-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }

.tip-box {
  background: linear-gradient(135deg, rgba(232,160,191,0.06), rgba(196,168,224,0.06));
  border: 1.5px solid var(--border);
  border-radius: 16px;
  padding: 0.9rem 1.1rem;
  font-size: 0.74rem;
  color: var(--muted);
  line-height: 1.65;
}

.tip-box strong { color: var(--pink-d); font-weight: 600; }

/* CONTEXT MENU */
.ctx-menu {
  position: fixed;
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 18px;
  z-index: 1000;
  min-width: 190px;
  display: none;
  box-shadow: 0 12px 40px rgba(196,168,224,0.2);
  padding: 6px;
}

.ctx-menu.show { display: block; animation: popIn 0.14s ease; }

@keyframes popIn {
  from { opacity: 0; transform: scale(0.94) translateY(-4px); }
  to   { opacity: 1; transform: scale(1) translateY(0); }
}

.ctx-item {
  display: flex; align-items: center; gap: 0.65rem;
  padding: 0.65rem 0.9rem;
  font-size: 0.83rem;
  font-family: 'Plus Jakarta Sans', sans-serif;
  color: var(--text);
  cursor: pointer;
  border-radius: 12px;
  transition: background 0.12s;
}

.ctx-item:hover { background: var(--border); }
.ctx-icon { font-size: 0.85rem; width: 18px; text-align: center; }
.ctx-div { height: 1px; background: var(--border); margin: 4px 2px; }
.ctx-item.danger { color: var(--red); }
.ctx-item.danger:hover { background: rgba(224,96,128,0.08); }

/* TOAST */
.toast {
  position: fixed;
  bottom: 2rem; left: 50%;
  transform: translateX(-50%) translateY(5rem);
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 20px;
  padding: 0.65rem 1.4rem;
  font-size: 0.8rem;
  color: var(--text);
  box-shadow: 0 8px 32px rgba(196,168,224,0.18);
  z-index: 9999;
  white-space: nowrap;
  transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1);
}

.toast.show { transform: translateX(-50%) translateY(0); }

/* DEBUG */
#debug-toggle {
  position: fixed; bottom: 1.5rem; right: 1.5rem;
  width: 36px; height: 36px; border-radius: 50%;
  background: var(--surface);
  border: 1.5px solid var(--border);
  color: var(--muted);
  cursor: pointer; font-size: 0.95rem;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 2px 12px rgba(196,168,224,0.15);
  z-index: 9998;
  transition: all 0.2s;
}

#debug-toggle:hover { border-color: var(--pink); color: var(--pink-d); }

#debug-panel {
  display: none;
  position: fixed; bottom: 4.5rem; right: 1rem;
  width: min(380px,95vw); max-height: 280px; overflow-y: auto;
  background: #1e1428;
  border: 1.5px solid #3a2a4a;
  border-radius: 16px;
  padding: 0.75rem 1rem;
  font-family: monospace; font-size: 0.68rem;
  z-index: 9997;
  box-shadow: 0 12px 40px rgba(0,0,0,0.25);
}

@media (max-width: 720px) {
  .layout { grid-template-columns: 1fr; padding: 1rem; gap: 1.25rem; }
  .stat-grid { grid-template-columns: repeat(4,1fr); }
  header { padding: 0.8rem 1rem; }
  .user-chip { display: none; }
}

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}

.cal-grid { animation: fadeUp 0.22s ease; }
</style>
</head>
<body>

<!-- AUTH -->
<div id="auth-screen">
  <div class="auth-wrap">
    <div class="auth-logo">
      <h1>Absensi</h1>
      <p>Rekap kehadiran harian</p>
    </div>
    <div class="auth-card">
      <div id="login-form">
        <div class="form-group">
          <label>Surel</label>
          <input type="email" id="email" placeholder="nama@email.com" autocomplete="email">
        </div>
        <div class="form-group">
          <label>Kata sandi</label>
          <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
        </div>
        <button class="btn-primary" onclick="login()">Masuk</button>
        <button class="btn-ghost" onclick="showRegister()">Belum punya akun? Daftar</button>
      </div>
      <div id="register-form" style="display:none">
        <div class="form-group">
          <label>Surel</label>
          <input type="email" id="reg-email" placeholder="nama@email.com">
        </div>
        <div class="form-group">
          <label>Kata sandi</label>
          <input type="password" id="reg-password" placeholder="Min. 6 karakter">
        </div>
        <button class="btn-primary" onclick="register()">Buat akun</button>
        <button class="btn-ghost" onclick="showLogin()">Sudah punya akun? Masuk</button>
      </div>
      <div class="auth-msg" id="auth-msg"></div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <header>
    <div class="logo">‚úø Absensi</div>
    <div class="header-right">
      <span class="user-chip" id="user-email-display"></span>
      <button class="btn-out" onclick="logout()">Keluar</button>
    </div>
  </header>

  <div class="layout">
    <div>
      <div class="cal-header">
        <button class="nav-btn" onclick="changePeriode(-1)">‚Üê</button>
        <div class="period-label" id="period-label">‚Äî</div>
        <button class="nav-btn" onclick="changePeriode(1)">‚Üí</button>
      </div>
      <div class="cal-box">
        <div class="day-names">
          <div class="day-name we">Min</div>
          <div class="day-name">Sen</div>
          <div class="day-name">Sel</div>
          <div class="day-name">Rab</div>
          <div class="day-name">Kam</div>
          <div class="day-name">Jum</div>
          <div class="day-name we">Sab</div>
        </div>
        <div class="cal-grid" id="cal-grid">
          <div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--muted);font-size:0.8rem">Memuat...</div>
        </div>
      </div>
    </div>

    <div class="sidebar">
      <div class="period-chip">
        <div class="chip-label">Periode Gaji</div>
        <div class="chip-val" id="stat-periode">‚Äî</div>
      </div>

      <div class="stat-grid">
        <div class="stat-card c-hadir">
          <div class="stat-lbl">Masuk</div>
          <div class="stat-val" id="stat-hadir">0</div>
          <div class="stat-unit">hari</div>
        </div>
        <div class="stat-card c-lembur">
          <div class="stat-lbl">Lembur</div>
          <div class="stat-val" id="stat-lembur">0</div>
          <div class="stat-unit">kali</div>
        </div>
        <div class="stat-card c-libur">
          <div class="stat-lbl">Libur</div>
          <div class="stat-val" id="stat-libur">0</div>
          <div class="stat-unit">hari</div>
        </div>
        <div class="stat-card c-cuti">
          <div class="stat-lbl">Cuti</div>
          <div class="stat-val" id="stat-cuti">0</div>
          <div class="stat-unit">hari</div>
        </div>
      </div>

      <div class="legend-box">
        <div class="leg-title">Keterangan</div>
        <div class="leg-item"><div class="leg-dot" style="background:#5a9e78"></div> Hadir Normal</div>
        <div class="leg-item"><div class="leg-dot" style="background:var(--pink-d)"></div> Hadir + Lembur</div>
        <div class="leg-item"><div class="leg-dot" style="background:#5a82b4"></div> Libur Resmi</div>
        <div class="leg-item"><div class="leg-dot" style="background:var(--purple-d)"></div> Izin / Cuti / Sakit</div>
      </div>

      <div class="tip-box">
        <strong>Cara pakai</strong><br>
        Ketuk tanggal untuk memilih status. Periode dihitung dari tgl 16 s/d 15 bulan berikutnya.
      </div>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div class="ctx-menu" id="ctx-menu">
  <div class="ctx-item" onclick="setStatus('hadir')"><span class="ctx-icon" style="color:#5a9e78">‚úì</span> Hadir Normal</div>
  <div class="ctx-item" onclick="setStatus('lembur')"><span class="ctx-icon" style="color:var(--pink-d)">‚è∞</span> Hadir + Lembur</div>
  <div class="ctx-div"></div>
  <div class="ctx-item" onclick="setStatus('libur')"><span class="ctx-icon" style="color:#5a82b4">‚ú¶</span> Libur Resmi</div>
  <div class="ctx-item" onclick="setStatus('cuti')"><span class="ctx-icon" style="color:var(--purple-d)">‚ú¶</span> Izin / Cuti / Sakit</div>
  <div class="ctx-div"></div>
  <div class="ctx-item danger" onclick="setStatus(null)"><span class="ctx-icon">‚úï</span> Hapus Tanda</div>
</div>

<div class="toast" id="toast"></div>

<button id="debug-toggle" onclick="toggleDebug()">üêõ</button>
<div id="debug-panel">
  <div style="color:var(--pink);font-size:0.6rem;letter-spacing:0.15em;margin-bottom:6px">DEBUG LOG ‚úø</div>
  <div id="debug-log" style="color:#b89ccc;font-size:0.65rem">Belum ada log.</div>
</div>

<script>
const SUPABASE_URL      = 'https://rzynbnftppgpiofnqcuc.supabase.co'
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ6eW5ibmZ0cHBncGlvZm5xY3VjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzOTg3OTYsImV4cCI6MjA4Njk3NDc5Nn0.l0xS2NeZ8jf7M44kwkauh34iG5uWaBbGBU6braSiFdo'

const { createClient } = supabase
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

let currentUser  = null
let currentDate  = new Date()
let attendanceData = {}
let selectedDate = null

// DEBUG
const logs = []
function dbg(level, ctx, msg, detail) {
  const t = new Date().toLocaleTimeString('id-ID')
  logs.unshift({ t, level, ctx, msg, detail })
  if (logs.length > 50) logs.pop()
  const el = document.getElementById('debug-log')
  if (!el) return
  const c = { INFO:'#a8d4b8', WARN:'#e8c880', ERROR:'#e8a0a0' }
  el.innerHTML = logs.slice(0,15).map(e =>
    `<div style="border-bottom:1px solid #3a2a4a;padding:3px 0;color:${c[e.level]||'#b89ccc'}">
      <span style="color:#6a4a7a">${e.t}</span>
      <span style="color:#e8e0f0"> [${e.ctx}]</span> ${e.msg}
      ${e.detail ? `<div style="color:#6a4a7a;word-break:break-all;padding-left:8px">${JSON.stringify(e.detail)}</div>` : ''}
    </div>`
  ).join('')
}

function toggleDebug() {
  const p = document.getElementById('debug-panel')
  const b = document.getElementById('debug-toggle')
  const open = p.style.display === 'block'
  p.style.display = open ? 'none' : 'block'
  b.textContent = open ? 'üêõ' : '‚úï'
}

// AUTH
async function login() {
  const email = document.getElementById('email').value.trim()
  const pw    = document.getElementById('password').value
  if (!email || !pw) return showMsg('Isi semua kolom.', false)
  const { data, error } = await db.auth.signInWithPassword({ email, password: pw })
  if (error) { dbg('ERROR','login','Gagal',error); return showMsg(error.message, false) }
  dbg('INFO','login','OK: '+data.user.email)
  onLogin(data.user)
}

async function register() {
  const email = document.getElementById('reg-email').value.trim()
  const pw    = document.getElementById('reg-password').value
  if (!email || !pw) return showMsg('Isi semua kolom.', false)
  if (pw.length < 6)  return showMsg('Kata sandi min. 6 karakter.', false)
  const { error } = await db.auth.signUp({ email, password: pw })
  if (error) return showMsg(error.message, false)
  showMsg('‚úì Akun dibuat! Silakan masuk.', true)
  showLogin()
}

async function logout() {
  await db.auth.signOut()
  currentUser = null; attendanceData = {}
  document.getElementById('auth-screen').style.display = 'flex'
  document.getElementById('app').style.display = 'none'
}

function showRegister() {
  document.getElementById('login-form').style.display = 'none'
  document.getElementById('register-form').style.display = 'block'
  clearMsg()
}

function showLogin() {
  document.getElementById('login-form').style.display = 'block'
  document.getElementById('register-form').style.display = 'none'
  clearMsg()
}

function showMsg(msg, ok) {
  const el = document.getElementById('auth-msg')
  el.textContent = msg
  el.style.color = ok ? '#5a9e78' : 'var(--red)'
  el.style.display = 'block'
}

function clearMsg() { document.getElementById('auth-msg').style.display = 'none' }

function onLogin(user) {
  dbg('INFO','onLogin','User: '+user.email)
  currentUser = user
  document.getElementById('auth-screen').style.display = 'none'
  document.getElementById('app').style.display = 'block'
  document.getElementById('user-email-display').textContent = user.email
  renderCalendar()
  loadAttendance()
}

// PERIODE
function getPeriode() {
  const y = currentDate.getFullYear()
  const m = currentDate.getMonth()
  return { start: new Date(y, m, 16), end: new Date(y, m+1, 15) }
}

// DATABASE
async function loadAttendance() {
  const { start, end } = getPeriode()
  const from = start.toLocaleDateString('sv-SE')
  const to   = end.toLocaleDateString('sv-SE')
  dbg('INFO','load',`${from} ‚Üí ${to}`)
  try {
    const { data: s } = await db.auth.getSession()
    dbg('INFO','auth','Session: '+(s?.session?.user?.id?.slice(0,8)||'none'))
    const { data, error } = await db.from('attendance').select('date,status').gte('date',from).lte('date',to)
    if (error) { dbg('ERROR','load','Query gagal',error); showToast('Gagal memuat data'); return }
    dbg('INFO','load',`${data?.length??0} baris`)
    attendanceData = {}
    data?.forEach(r => { attendanceData[r.date] = r.status })
    renderCalendar()
  } catch(e) { dbg('ERROR','load','Exception',{msg:e.message}) }
}

async function saveAttendance(dateStr, status) {
  dbg('INFO','save',`${dateStr} ‚Üí ${status??'hapus'}`)
  if (status === null) {
    const { error } = await db.from('attendance').delete().eq('user_id',currentUser.id).eq('date',dateStr)
    if (error) { dbg('ERROR','save','Hapus gagal',error); showToast('Gagal menghapus'); return }
    delete attendanceData[dateStr]
  } else {
    const { error } = await db.from('attendance')
      .upsert({ user_id: currentUser.id, date: dateStr, status }, { onConflict:'user_id,date' })
    if (error) { dbg('ERROR','save','Simpan gagal',error); showToast('Gagal menyimpan'); return }
    attendanceData[dateStr] = status
  }
  dbg('INFO','save','OK')
  renderCalendar()
  updateStats()
}

// CALENDAR
const MN = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des']

function renderCalendar() {
  const today = new Date()
  const { start, end } = getPeriode()
  const lbl = `${start.getDate()} ${MN[start.getMonth()]} ‚Äî ${end.getDate()} ${MN[end.getMonth()]} ${end.getFullYear()}`
  document.getElementById('period-label').textContent = lbl

  const grid = document.getElementById('cal-grid')
  grid.innerHTML = ''

  for (let i = 0; i < start.getDay(); i++) {
    const e = document.createElement('div')
    e.className = 'cal-cell empty'
    grid.appendChild(e)
  }

  const cursor = new Date(start)
  while (cursor <= end) {
    const y = cursor.getFullYear()
    const m = cursor.getMonth()
    const d = cursor.getDate()
    const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`
    const dow = cursor.getDay()
    const isWE    = dow === 0 || dow === 6
    const isToday = y === today.getFullYear() && m === today.getMonth() && d === today.getDate()
    const status  = attendanceData[dateStr]

    const cell = document.createElement('div')
    cell.className = `cal-cell${isWE?' weekend':''}${isToday?' today':''}${status?' '+status:''}`

    const monthTag = d === 1 ? `<div class="month-tag">${MN[m]}</div>` : ''
    const dot = status ? `<div class="cal-dot"></div>` : ''
    cell.innerHTML = `${monthTag}<span class="cal-date">${d}</span>${dot}`

    cell.addEventListener('click', e => { e.stopPropagation(); openMenu(e, dateStr) })
    cell.addEventListener('contextmenu', e => { e.preventDefault(); openMenu(e, dateStr) })

    grid.appendChild(cell)
    cursor.setDate(cursor.getDate() + 1)
  }

  updateStats()
}

function updateStats() {
  const vals = Object.values(attendanceData)
  const hadir  = vals.filter(v => v==='hadir').length
  const lembur = vals.filter(v => v==='lembur').length
  const libur  = vals.filter(v => v==='libur').length
  const cuti   = vals.filter(v => v==='cuti').length

  document.getElementById('stat-hadir').textContent  = hadir + lembur
  document.getElementById('stat-lembur').textContent = lembur
  document.getElementById('stat-libur').textContent  = libur
  document.getElementById('stat-cuti').textContent   = cuti

  const { start, end } = getPeriode()
  document.getElementById('stat-periode').textContent =
    `${start.getDate()} ${MN[start.getMonth()]} ‚Äî ${end.getDate()} ${MN[end.getMonth()]} ${end.getFullYear()}`
}

async function changePeriode(dir) {
  currentDate.setMonth(currentDate.getMonth() + dir)
  attendanceData = {}
  renderCalendar()
  await loadAttendance()
}

// CONTEXT MENU
function openMenu(e, dateStr) {
  e.preventDefault()
  selectedDate = dateStr
  const menu = document.getElementById('ctx-menu')
  menu.classList.add('show')
  let x = e.clientX, y = e.clientY
  if (x + 200 > window.innerWidth)  x = window.innerWidth - 205
  if (y + 230 > window.innerHeight) y = window.innerHeight - 235
  menu.style.left = x+'px'
  menu.style.top  = y+'px'
}

function closeMenu() { document.getElementById('ctx-menu').classList.remove('show') }

async function setStatus(status) {
  if (!selectedDate) return
  closeMenu()
  await saveAttendance(selectedDate, status)
  const labels = { hadir:'Ditandai: Hadir', lembur:'Ditandai: Lembur', libur:'Ditandai: Libur', cuti:'Ditandai: Cuti/Izin' }
  showToast(status ? labels[status] : 'Tanda dihapus')
}

document.addEventListener('click', e => {
  if (!document.getElementById('ctx-menu').contains(e.target)) closeMenu()
})

// TOAST
let toastTimer
function showToast(msg) {
  const t = document.getElementById('toast')
  t.textContent = msg
  t.classList.add('show')
  clearTimeout(toastTimer)
  toastTimer = setTimeout(() => t.classList.remove('show'), 2500)
}

// INIT
db.auth.getSession().then(({ data: { session } }) => {
  if (session) onLogin(session.user)
})

document.addEventListener('keydown', e => {
  if (e.key !== 'Enter') return
  document.getElementById('register-form').style.display !== 'none' ? register() : login()
})
</script>
</body>
</html>
