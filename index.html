<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Absensi</title>
<link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Google+Sans+Display:wght@400;500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
</head>
<body>

<!-- â•â• AUTH â•â• -->
<div id="auth-screen">
  <div class="auth-wrap">
    <div class="auth-logo">
      <div class="auth-icon">ğŸŒ¸</div>
      <h1>Absensi</h1>
      <p>Rekap kehadiran harian</p>
    </div>
    <div class="auth-card">
      <!-- Login -->
      <div id="login-form">
        <p class="form-section-title">Masuk</p>
        <div class="m3-field">
          <input type="email" id="email" placeholder=" " autocomplete="email">
          <label>Surel</label>
        </div>
        <div class="m3-field">
          <input type="password" id="password" placeholder=" " autocomplete="current-password">
          <label>Kata sandi</label>
          <button type="button" class="eye-btn" onclick="togglePw('password',this)" tabindex="-1" aria-label="Tampilkan sandi">ğŸ‘</button>
        </div>
        <button class="btn-filled" onclick="login()">Masuk</button>
        <button class="btn-text" onclick="showRegister()">Belum punya akun? Daftar</button>
      </div>

      <!-- Register -->
      <div id="register-form" style="display:none">
        <p class="form-section-title">Buat Akun</p>
        <div class="m3-field">
          <input type="text" id="reg-username" placeholder=" " autocomplete="nickname">
          <label>Username</label>
        </div>
        <div class="m3-field">
          <input type="email" id="reg-email" placeholder=" ">
          <label>Surel</label>
        </div>
        <div class="m3-field">
          <input type="password" id="reg-password" placeholder=" ">
          <label>Kata sandi (min. 6 karakter)</label>
          <button type="button" class="eye-btn" onclick="togglePw('reg-password',this)" tabindex="-1" aria-label="Tampilkan sandi">ğŸ‘</button>
        </div>
        <button class="btn-filled" onclick="register()">Buat akun</button>
        <button class="btn-text" onclick="showLogin()">Sudah punya akun? Masuk</button>
      </div>

      <div class="auth-msg" id="auth-msg"></div>
    </div>
  </div>
</div>

<!-- â•â• APP â•â• -->
<div id="app">
  <header>
    <div class="app-bar-title">ğŸŒ¸ Absensi <span id="header-username" style="font-weight:400;opacity:0.75"></span></div>
    <div class="app-bar-right">
      <span class="user-pill" id="user-email-display"></span>
      <button class="btn-icon" onclick="logout()" title="Keluar">â†©</button>
    </div>
  </header>

  <div class="layout">
    <!-- Calendar -->
    <div>
      <div class="cal-nav">
        <button class="btn-icon-outlined" onclick="changePeriode(-1)">â†</button>
        <div class="period-display" id="period-label">â€”</div>
        <button class="btn-icon-outlined" onclick="changePeriode(1)">â†’</button>
      </div>
      <div class="cal-card">
        <div class="day-row">
          <div class="day-hdr we">Min</div>
          <div class="day-hdr">Sen</div>
          <div class="day-hdr">Sel</div>
          <div class="day-hdr">Rab</div>
          <div class="day-hdr">Kam</div>
          <div class="day-hdr">Jum</div>
          <div class="day-hdr we">Sab</div>
        </div>
        <div class="cal-grid" id="cal-grid">
          <div style="grid-column:1/-1;text-align:center;padding:3rem;color:var(--md-on-surface-variant);font-size:0.875rem">Memuat...</div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
      <div class="period-card">
        <div class="label">Periode Gaji</div>
        <div class="value" id="stat-periode">â€”</div>
      </div>

      <div class="stat-grid">
        <div class="stat-card c-hadir">
          <div class="s-label">Masuk</div>
          <div class="s-val" id="stat-hadir">0</div>
          <div class="s-unit">hari</div>
        </div>
        <div class="stat-card c-lembur">
          <div class="s-label">Lembur</div>
          <div class="s-val" id="stat-lembur">0</div>
          <div class="s-unit">kali lembur</div>
        </div>
        <div class="stat-card c-libur">
          <div class="s-label">Libur</div>
          <div class="s-val" id="stat-libur">0</div>
          <div class="s-unit">hari</div>
        </div>
        <div class="stat-card c-cuti">
          <div class="s-label">Cuti</div>
          <div class="s-val" id="stat-cuti">0</div>
          <div class="s-unit">hari</div>
        </div>
      </div>

      <div class="gaji-card">
        <div class="gaji-title">Estimasi Gaji</div>

        <!-- Uang Makan Hadir -->
        <div class="gaji-row">
          <span class="gaji-row-label">
            <span class="g-chip" style="background:var(--c-hadir-bg);color:var(--c-hadir)">Makan</span>
            <span id="gaji-makan-detail" style="font-size:0.75rem;opacity:0.7"></span>
          </span>
          <span class="gaji-row-val" id="gaji-makan">Rp 0</span>
        </div>

        <!-- Uang Makan Ditarik -->
        <div class="gaji-row">
          <span class="gaji-row-label">
            <span class="g-chip" style="background:#FFF3E0;color:#E65100;cursor:pointer" onclick="openHistoryDialog()" title="Lihat history">Ditarik â€º</span>
            <span id="gaji-tarik-detail" style="font-size:0.75rem;opacity:0.7"></span>
          </span>
          <span class="gaji-row-val" id="gaji-tarik" style="color:#E65100">Rp 0</span>
        </div>

        <!-- Sisa Uang Makan -->
        <div class="gaji-row" id="gaji-sisa-row">
          <span class="gaji-row-label">
            <span class="g-chip" style="background:#E8F5E9;color:#2E7D32">Sisa</span>
          </span>
          <span class="gaji-row-val" id="gaji-sisa" style="color:#2E7D32">Rp 0</span>
        </div>

        <!-- Uang Lembur -->
        <div class="gaji-row">
          <span class="gaji-row-label">
            <span class="g-chip" style="background:var(--c-lembur-bg);color:var(--c-lembur)">Lembur</span>
            <span id="gaji-lembur-detail" style="font-size:0.75rem;opacity:0.7"></span>
          </span>
          <span class="gaji-row-val" id="gaji-lembur-val">Rp 0</span>
        </div>

        <div class="gaji-divider"></div>

        <div class="gaji-total-row">
          <span class="gaji-total-label">Total Estimasi</span>
          <span class="gaji-total-val" id="gaji-total">Rp 0</span>
        </div>

        <!-- Tombol Tarik Uang Makan -->
        <button class="tarik-btn" onclick="openTarikDialog()">
          + Catat Tarikan Uang Makan
        </button>
      </div>

      <div class="legend-card">
        <div class="legend-title">Keterangan</div>
        <div class="leg-item">
          <div class="leg-chip" style="background:var(--c-hadir-bg);color:var(--c-hadir)">Hadir</div>
          Normal
        </div>
        <div class="leg-item">
          <div class="leg-chip" style="background:var(--c-lembur-bg);color:var(--c-lembur)">Lembur</div>
          Hadir + lembur
        </div>
        <div class="leg-item">
          <div class="leg-chip" style="background:var(--c-libur-bg);color:var(--c-libur)">Libur</div>
          Libur resmi
        </div>
        <div class="leg-item">
          <div class="leg-chip" style="background:var(--c-cuti-bg);color:var(--c-cuti)">Cuti</div>
          Izin/cuti/sakit
        </div>
        <div class="leg-item">
          <div class="leg-chip" style="background:var(--c-bonus-bg);color:var(--c-bonus)">Bonus</div>
          Libur bonus ğŸ
        </div>
      </div>

      <div class="notes-list-card" id="notes-list-card">
        <div class="notes-list-title">Catatan Periode</div>
        <div id="notes-list-body">
          <span class="note-empty">Belum ada catatan untuk periode ini</span>
        </div>
      </div>

      <div class="info-card" id="info-card-tip">
        <p>Ketuk tanggal untuk memilih status. Periode: tgl <strong id="periode-start-label">16</strong> s/d <strong id="periode-end-label">15</strong> bulan berikutnya. <span id="ganti-periode-btn" style="color:var(--md-primary);cursor:pointer;font-weight:500;text-decoration:underline;white-space:nowrap" onclick="openPeriodeDialog()">Ubah</span></p>
      </div>
    </div>
  </div>
</div>

<!-- Username Setup Dialog -->
<div class="dialog-scrim" id="username-dialog">
  <div class="dialog">
    <div class="dialog-icon">ğŸ‘¤</div>
    <div class="dialog-title">Hei, siapa namamu?</div>
    <div class="dialog-subtitle">Username akan ditampilkan di dashboard</div>
    <div class="dialog-field" style="margin-top:1rem">
      <textarea id="username-input" placeholder="Contoh: Wildan, Laurent, Yves..." rows="1"
        style="resize:none;min-height:48px;max-height:48px;line-height:1.5;padding-top:0.75rem"></textarea>
    </div>
    <div class="dialog-actions">
      <button class="dialog-btn-filled" onclick="confirmUsername()" style="width:100%">Simpan</button>
    </div>
  </div>
</div>

<!-- Tarik Uang Makan Dialog -->
<div class="dialog-scrim" id="tarik-dialog">
  <div class="dialog">
    <div class="dialog-icon">ğŸ’µ</div>
    <div class="dialog-title">Catat Tarikan</div>
    <div class="dialog-subtitle" id="tarik-dialog-periode">â€”</div>
    <div class="dialog-field" style="margin-top:1rem">
      <label style="font-family:'Google Sans',sans-serif;font-size:0.75rem;font-weight:500;color:var(--md-on-surface-variant);letter-spacing:0.06em;text-transform:uppercase;display:block;margin-bottom:0.5rem">Jumlah (Rp)</label>
      <input type="number" id="tarik-amount" placeholder="Contoh: 280000"
        style="width:100%;padding:0.75rem 1rem;border:1.5px solid var(--md-outline-variant);border-radius:var(--shape-md);font-family:'Google Sans Display',sans-serif;font-size:1.5rem;color:var(--md-primary);background:var(--md-surface-container);outline:none;-moz-appearance:textfield"
        oninput="updateTarikPreview()">
      <div id="tarik-preview" style="font-size:0.75rem;color:var(--md-on-surface-variant);margin-top:0.4rem;min-height:1rem"></div>
    </div>
    <div class="dialog-field">
      <textarea id="tarik-note" placeholder="Catatan opsional..." rows="2" style="resize:none;min-height:56px;max-height:56px"></textarea>
    </div>
    <div class="dialog-actions">
      <button class="dialog-btn-text" onclick="closeTarikDialog()">Batal</button>
      <button class="dialog-btn-filled" onclick="confirmTarik()">Simpan</button>
    </div>
  </div>
</div>

<!-- History Tarikan Dialog -->
<div class="dialog-scrim" id="history-dialog">
  <div class="dialog" style="max-width:380px">
    <div class="dialog-icon">ğŸ“‹</div>
    <div class="dialog-title">History Tarikan</div>
    <div class="dialog-subtitle" id="history-dialog-periode">â€”</div>
    <div id="history-list" style="max-height:300px;overflow-y:auto;margin-top:0.75rem"></div>
    <div class="dialog-actions" style="justify-content:center">
      <button class="dialog-btn-filled" onclick="closeHistoryDialog()" style="width:100%">Tutup</button>
    </div>
  </div>
</div>

<!-- Note Dialog -->
<div class="dialog-scrim" id="note-dialog">
  <div class="dialog">
    <div class="dialog-icon">ğŸ¤’</div>
    <div class="dialog-title">Keterangan</div>
    <div class="dialog-subtitle" id="note-dialog-date">â€”</div>
    <div class="dialog-field">
      <textarea id="note-input" placeholder="Contoh: demam, urusan keluarga, cuti tahunan..."></textarea>
    </div>
    <div class="dialog-actions">
      <button class="dialog-btn-text" onclick="closeNoteDialog()">Batal</button>
      <button class="dialog-btn-filled" onclick="confirmCuti()">Simpan</button>
    </div>
  </div>
</div>

<!-- Periode Dialog -->
<div class="dialog-scrim" id="periode-dialog">
  <div class="dialog">
    <div class="dialog-icon">ğŸ“…</div>
    <div class="dialog-title">Periode Gaji</div>
    <div class="dialog-subtitle">Pilih tanggal mulai dan akhir bebas</div>
    <div class="periode-dual-stepper">
      <div class="pds-col">
        <div class="pds-label">Mulai</div>
        <button class="pds-btn" onclick="adjustDay('start',-1)">âˆ’</button>
        <div class="pds-val" id="ps-val">16</div>
        <button class="pds-btn" onclick="adjustDay('start',1)">+</button>
      </div>
      <div class="pds-arrow">â†’</div>
      <div class="pds-col">
        <div class="pds-label">Akhir</div>
        <button class="pds-btn" onclick="adjustDay('end',-1)">âˆ’</button>
        <div class="pds-val" id="pe-val">15</div>
        <button class="pds-btn" onclick="adjustDay('end',1)">+</button>
      </div>
    </div>
    <div class="pds-preview" id="periode-preview-text">â€”</div>
    <div class="pds-hint" id="periode-preview-hint"></div>
    <div class="dialog-actions">
      <button class="dialog-btn-text" onclick="closePeriodeDialog()">Batal</button>
      <button class="dialog-btn-filled" onclick="confirmPeriode()">Simpan</button>
    </div>
  </div>
</div>

<!-- Bonus Dialog -->
<div class="dialog-scrim" id="bonus-dialog">
  <div class="dialog">
    <div class="dialog-icon">ğŸ</div>
    <div class="dialog-title">Libur Bonus</div>
    <div class="dialog-subtitle" id="bonus-dialog-date">â€”</div>
    <div class="dialog-field">
      <textarea id="bonus-note-input" placeholder="Contoh: Imlek, HUT perusahaan, acara khusus..."></textarea>
    </div>
    <div class="dialog-actions">
      <button class="dialog-btn-text" onclick="closeBonusDialog()">Batal</button>
      <button class="dialog-btn-filled" onclick="confirmBonus()">Simpan</button>
    </div>
  </div>
</div>

<!-- Lembur Dialog -->
<div class="dialog-scrim" id="lembur-dialog">
  <div class="dialog">
    <div class="dialog-icon">â°</div>
    <div class="dialog-title">Lembur</div>
    <div class="dialog-subtitle" id="lembur-dialog-date">â€”</div>
    <div class="dialog-field" style="margin-bottom:0.75rem">
      <label style="font-family:'Google Sans',sans-serif;font-size:0.75rem;font-weight:500;color:var(--md-on-surface-variant);letter-spacing:0.06em;text-transform:uppercase;display:block;margin-bottom:0.5rem">Jumlah Lembur</label>
      <div style="display:flex;align-items:center;gap:0.75rem">
        <button onclick="adjustLembur(-1)" style="width:36px;height:36px;border-radius:50%;border:1.5px solid var(--md-outline-variant);background:transparent;font-size:1.1rem;cursor:pointer;color:var(--c-lembur);display:flex;align-items:center;justify-content:center;transition:background 0.15s" onmouseover="this.style.background='rgba(139,74,107,0.08)'" onmouseout="this.style.background='transparent'">âˆ’</button>
        <div style="flex:1;text-align:center">
          <div id="lembur-count-display" style="font-family:'Google Sans Display',sans-serif;font-size:2.5rem;font-weight:400;color:var(--c-lembur);line-height:1">1</div>
          <div style="font-size:0.7rem;color:var(--md-on-surface-variant);margin-top:2px">kali lembur</div>
        </div>
        <button onclick="adjustLembur(1)" style="width:36px;height:36px;border-radius:50%;border:1.5px solid var(--md-outline-variant);background:transparent;font-size:1.1rem;cursor:pointer;color:var(--c-lembur);display:flex;align-items:center;justify-content:center;transition:background 0.15s" onmouseover="this.style.background='rgba(139,74,107,0.08)'" onmouseout="this.style.background='transparent'">+</button>
      </div>
    </div>
    <div class="dialog-field" id="lembur-note-field" style="display:none;animation:fadeUp 0.18s ease">
      <label style="font-family:'Google Sans',sans-serif;font-size:0.75rem;font-weight:500;color:var(--md-on-surface-variant);letter-spacing:0.06em;text-transform:uppercase;display:block;margin-bottom:0.5rem">Keterangan <span style="opacity:0.5;font-weight:400;text-transform:none">(opsional)</span></label>
      <textarea id="lembur-note-input" placeholder="Contoh: meeting klien, deadline project..."></textarea>
    </div>
    <div class="dialog-actions">
      <button class="dialog-btn-text" onclick="closeLemburDialog()">Batal</button>
      <button class="dialog-btn-filled" onclick="confirmLembur()">Simpan</button>
    </div>
  </div>
</div>

<!-- M3 Menu -->
<div class="ctx-menu" id="ctx-menu">
  <div class="ctx-item" onclick="setStatus('hadir')">
    <div class="ctx-lead" style="background:var(--c-hadir-bg);color:var(--c-hadir)">âœ“</div>
    Hadir Normal
  </div>
  <div class="ctx-item" onclick="setStatus('lembur')">
    <div class="ctx-lead" style="background:var(--c-lembur-bg);color:var(--c-lembur)">â°</div>
    Hadir + Lembur
  </div>
  <div class="ctx-div"></div>
  <div class="ctx-item" onclick="setStatus('libur')">
    <div class="ctx-lead" style="background:var(--c-libur-bg);color:var(--c-libur)">âœ¦</div>
    Libur Resmi
  </div>
  <div class="ctx-item" onclick="setStatus('cuti')">
    <div class="ctx-lead" style="background:var(--c-cuti-bg);color:var(--c-cuti)">âœ¦</div>
    Izin / Cuti / Sakit
  </div>
  <div class="ctx-item" onclick="setStatus('bonus')">
    <div class="ctx-lead" style="background:var(--c-bonus-bg);color:var(--c-bonus)">ğŸ</div>
    Libur Bonus
  </div>
  <div class="ctx-div"></div>
  <div class="ctx-item danger" onclick="setStatus(null)">
    <div class="ctx-lead">âœ•</div>
    Hapus Tanda
  </div>
</div>

<div class="toast" id="toast"></div>

<button id="debug-toggle" onclick="toggleDebug()">ğŸ›</button>
<div id="debug-panel">
  <div style="color:#FFB3C9;font-size:0.65rem;letter-spacing:0.1em;margin-bottom:8px;font-family:'Google Sans',sans-serif">DEBUG</div>
  <div id="debug-log" style="color:#D0BCFF;font-size:0.65rem">Belum ada log.</div>
</div>

<script src="app.js"></script>
</body>
</html>
